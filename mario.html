<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jelly Mario Demo</title>
<style>
  body {
    margin: 0;
    background: #5c94fc;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: auto;
    background: #8ED0F7;
    image-rendering: pixelated;
  }
</style>
</head>
<body>
<canvas id="game" width="640" height="360"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const GRAVITY = 0.6;
const JUMP_SPEED = -12;
const MOVE_SPEED = 4;
const groundY = 300;

const keys = {};
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// Mario state
const mario = {
  x: 50,
  y: groundY - 48,
  width: 48,
  height: 48,
  vx: 0,
  vy: 0,
  onGround: true,

  // Jelly effect params
  baseY: groundY - 48,
  bounce: 0,
  bounceVelocity: 0,

  // Squish scale
  scaleX: 1,
  scaleY: 1,
  scaleVelocityX: 0,
  scaleVelocityY: 0,

  facing: 'right'
};

// Ground squish state
const ground = {
  baseY: groundY,
  squish: 0,
  squishVelocity: 0,
  width: canvas.width,
  height: canvas.height - groundY
};

function updateJellyPhysics() {
  // Update Mario physics and apply jelly bounce on landing
  mario.vy += GRAVITY;
  mario.x += mario.vx;
  mario.y += mario.vy;

  // Check ground collision
  if (mario.y + mario.height >= groundY) {
    mario.y = groundY - mario.height;
    mario.vy = 0;
    if (!mario.onGround) {
      // Landed: trigger bounce and squish
      mario.bounceVelocity = -8;
      ground.squishVelocity = 5;
    }
    mario.onGround = true;
  } else {
    mario.onGround = false;
  }

  // Jelly bounce spring effect for Mario's vertical bounce
  const bounceSpring = 0.3;
  const bounceDamping = 0.6;
  mario.bounceVelocity += mario.bounce * -bounceSpring;
  mario.bounceVelocity *= bounceDamping;
  mario.bounce += mario.bounceVelocity;

  // Apply bounce offset to Mario's y
  mario.baseY = groundY - mario.height;
  mario.y = mario.baseY + mario.bounce;

  // Jelly squish spring for ground
  const squishSpring = 0.3;
  const squishDamping = 0.6;
  ground.squishVelocity += ground.squish * -squishSpring;
  ground.squishVelocity *= squishDamping;
  ground.squish += ground.squishVelocity;

  // Mario horizontal squish scales based on velocity and bounce
  const squishAmount = 0.1;
  mario.scaleX = 1 + squishAmount * Math.abs(mario.vx) - mario.bounce * 0.05;
  mario.scaleY = 1 - squishAmount * Math.abs(mario.vx) + mario.bounce * 0.1;

  // Limit scales to reasonable range
  mario.scaleX = Math.min(Math.max(mario.scaleX, 0.8), 1.2);
  mario.scaleY = Math.min(Math.max(mario.scaleY, 0.8), 1.2);

  // Keep Mario inside canvas
  if (mario.x < 0) mario.x = 0;
  if (mario.x + mario.width > canvas.width) mario.x = canvas.width - mario.width;
}

function drawGround() {
  ctx.save();
  ctx.fillStyle = '#0B6A0B';
  // Squish ground vertically by ground.squish
  ctx.translate(0, ground.squish);
  ctx.fillRect(0, ground.baseY, ground.width, ground.height);
  ctx.restore();
}

function drawMario() {
  ctx.save();
  ctx.translate(mario.x + mario.width / 2, mario.y + mario.height / 2);
  // Flip horizontally if facing left
  if (mario.facing === 'left') ctx.scale(-1, 1);
  // Apply jelly squish scale
  ctx.scale(mario.scaleX, mario.scaleY);
  ctx.fillStyle = '#d6336c'; // Classic Mario-ish red color
  ctx.fillRect(-mario.width / 2, -mario.height / 2, mario.width, mario.height);
  ctx.restore();
}

function update() {
  // Controls
  if (keys['arrowright'] || keys['d']) {
    mario.vx = MOVE_SPEED;
    mario.facing = 'right';
  } else if (keys['arrowleft'] || keys['a']) {
    mario.vx = -MOVE_SPEED;
    mario.facing = 'left';
  } else {
    mario.vx = 0;
  }

  if ((keys['arrowup'] || keys['w'] || keys[' ']) && mario.onGround) {
    mario.vy = JUMP_SPEED;
    mario.onGround = false;
  }

  updateJellyPhysics();
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawGround();
  drawMario();
  update();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
