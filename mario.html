<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mario Platformer</title>
<style>
  body {
    margin: 0;
    background: #5c94fc;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: auto;
    background: #8ED0F7;
    image-rendering: pixelated;
  }
</style>
</head>
<body>
<canvas id="game" width="640" height="360"></canvas>
<script>
// === IMAGE LINKS ===
const marioImages = {
  idle: [
    "https://www.videogamesprites.net/SuperMarioBros1/Characters/Mario/Mario%20-%20Idle1.gif"
  ],
  walk: [
    "https://www.videogamesprites.net/SuperMarioBros1/Characters/Mario/Mario%20-%20Walk1.gif",
    "https://www.videogamesprites.net/SuperMarioBros1/Characters/Mario/Mario%20-%20Walk2.gif",
    "https://www.videogamesprites.net/SuperMarioBros1/Characters/Mario/Mario%20-%20Walk3.gif"
  ],
  jump: "https://www.videogamesprites.net/SuperMarioBros1/Characters/Mario/Mario%20-%20Jump.gif",
};

const mushroomUrl = "https://www.videogamesprites.net/SuperMarioBros1/Items/Mushroom.gif";

// === GAME CONSTANTS ===
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const GRAVITY = 0.5;
const JUMP_SPEED = -10;
const MOVE_SPEED = 6;
const groundY = 300;

const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// === PLAYER ===
const player = {
  x: 50,
  y: groundY - 48,
  width: 48,
  height: 48,
  vx: 0,
  vy: 0,
  onGround: true,
  facing: "right",
  animFrame: 0,
  animTimer: 0,
  state: "idle",
  big: false
};

// === MUSHROOM ===
const mushroom = {
  x: 400,
  y: groundY - 32,
  width: 32,
  height: 32,
  collected: false,
  image: null
};

let images = {
  idle: [],
  walk: [],
  jump: null,
  mushroom: null
};

// === LOADERS ===
function preloadImages(urls, callback) {
  const imgs = [];
  let loaded = 0;
  if (!urls.length) return callback([]);

  urls.forEach((url, i) => {
    const img = new Image();
    img.src = url;
    img.onload = () => {
      imgs[i] = img;
      if (++loaded === urls.length) callback(imgs);
    };
    img.onerror = () => {
      console.warn("Error loading", url);
      imgs[i] = null;
      if (++loaded === urls.length) callback(imgs);
    };
  });
}

function loadAllImages(callback) {
  preloadImages(marioImages.idle, idleImgs => {
    images.idle = idleImgs;
    preloadImages(marioImages.walk, walkImgs => {
      images.walk = walkImgs;
      const jmp = new Image();
      jmp.src = marioImages.jump;
      jmp.onload = () => {
        images.jump = jmp;
        const mush = new Image();
        mush.src = mushroomUrl;
        mush.onload = () => {
          images.mushroom = mush;
          mushroom.image = mush;
          callback();
        };
      };
    });
  });
}

// === GAME FUNCTIONS ===
function drawGround() {
  ctx.fillStyle = "#0B6A0B";
  ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
}

function rectsCollide(r1, r2) {
  return !(r2.x > r1.x + r1.width ||
           r2.x + r2.width < r1.x ||
           r2.y > r1.y + r1.height ||
           r2.y + r2.height < r1.y);
}

function updatePlayer() {
  // Controls
  if (keys["ArrowRight"] || keys["d"]) {
    player.vx = MOVE_SPEED;
    player.facing = "right";
  } else if (keys["ArrowLeft"] || keys["a"]) {
    player.vx = -MOVE_SPEED;
    player.facing = "left";
  } else {
    player.vx = 0;
  }

  if ((keys["ArrowUp"] || keys["w"] || keys[" "]) && player.onGround) {
    player.vy = JUMP_SPEED;
    player.onGround = false;
  }

  // Physics
  player.vy += GRAVITY;
  player.x += player.vx;
  player.y += player.vy;

  // Ground collision
  if (player.y + player.height >= groundY) {
    player.y = groundY - player.height;
    player.vy = 0;
    player.onGround = true;
  } else {
    player.onGround = false;
  }

  // Bounds
  if (player.x < 0) player.x = 0;
  if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

  // Mushroom pickup
  if (!mushroom.collected && rectsCollide(player, mushroom)) {
    mushroom.collected = true;
    player.big = true;
    player.height = 64;
    player.y = groundY - player.height;
  }

  // State
  if (!player.onGround) player.state = "jump";
  else if (player.vx !== 0) player.state = "walk";
  else player.state = "idle";

  // Animation
  const frameCount = player.state === "walk" ? images.walk.length : images.idle.length;
  const speed = player.state === "walk" ? 5 : 15;

  if (frameCount > 1) {
    player.animTimer++;
    if (player.animTimer >= speed) {
      player.animFrame = (player.animFrame + 1) % frameCount;
      player.animTimer = 0;
    }
  } else {
    player.animFrame = 0;
  }
}

function drawPlayer() {
  ctx.imageSmoothingEnabled = false;
  let img = null;
  if (player.state === "walk") {
    img = images.walk[player.animFrame] || images.walk[0];
  } else if (player.state === "jump") {
    img = images.jump;
  } else {
    img = images.idle[0];
  }

  if (!img) return;

  ctx.save();
  ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
  if (player.facing === "left") ctx.scale(-1, 1);
  ctx.drawImage(img, -player.width / 2, -player.height / 2, player.width, player.height);
  ctx.restore();
}

function drawMushroom() {
  if (!mushroom.collected && mushroom.image) {
    ctx.drawImage(mushroom.image, mushroom.x, mushroom.y, mushroom.width, mushroom.height);
  }
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawGround();
  updatePlayer();
  drawMushroom();
  drawPlayer();
  requestAnimationFrame(gameLoop);
}

loadAllImages(() => {
  gameLoop();
});
</script>
</body>
</html>
