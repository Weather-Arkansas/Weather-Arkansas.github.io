<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5-Day Hourly Forecast</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  color: #fff;
  overflow-x: hidden;
}

#weather-background {
  position: fixed;
  inset: 0;
  z-index: -1;
  overflow: hidden;
  transition: background 1s;
}

#forecast-container {
  padding: 20px;
}

.day-container {
  margin-bottom: 40px;
}

h2 {
  border-bottom: 2px solid #1e3c72;
  padding-bottom: 5px;
  margin-bottom: 10px;
}

.hourly-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.hour-card {
  background: rgba(30, 60, 114, 0.9);
  border-radius: 8px;
  padding: 10px;
  cursor: pointer;
}

.hour-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.hour-details {
  display: none;
  font-size: 0.85em;
  margin-top: 6px;
}

.hour-card.expanded .hour-details {
  display: block;
}

.expand-btn {
  font-weight: bold;
  cursor: pointer;
}

/* PARTICLES */
.particle {
  position: absolute;
  width: 2px;
  height: 10px;
  background: rgba(255,255,255,0.7);
  animation: fall linear infinite;
}

@keyframes fall {
  from { transform: translateY(-20px); }
  to { transform: translateY(110vh); }
}

/* CLOUDS */
.cloud {
  position: absolute;
  background: rgba(255,255,255,0.35);
  border-radius: 50%;
  filter: blur(2px);
}
</style>
</head>

<body>
<div id="weather-background"></div>
<div id="forecast-container"></div>

<script>
const REFRESH_INTERVAL = 300000; // 5 minutes

function getLocation() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      pos => resolve(pos.coords),
      err => reject(err)
    );
  });
}

async function fetchForecast(lat, lon) {
  const point = await fetch(`https://api.weather.gov/points/${lat},${lon}`).then(r => r.json());
  return fetch(point.properties.forecastHourly).then(r => r.json());
}

function clearBackground() {
  document.getElementById('weather-background').innerHTML = '';
}

function setWeatherBackground(text, isDay) {
  const bg = document.getElementById('weather-background');
  clearBackground();

  let color = '#0b1d3a';

  if (/rain|storm/i.test(text)) color = '#2a3b4c';
  else if (/snow/i.test(text)) color = '#3b4a5b';
  else if (/cloud/i.test(text)) color = isDay ? '#7a8794' : '#2e3440';
  else if (/clear|sunny/i.test(text)) color = isDay ? '#87ceeb' : '#0b1d3a';

  bg.style.background = color;

  if (/cloud/i.test(text)) {
    for (let i = 0; i < 12; i++) {
      const c = document.createElement('div');
      c.className = 'cloud';
      const size = 120 + Math.random() * 180;
      c.style.width = size + 'px';
      c.style.height = size * 0.6 + 'px';
      c.style.top = Math.random() * 60 + '%';
      c.style.left = Math.random() * 100 + '%';
      bg.appendChild(c);
    }
  }

  if (/rain|storm/i.test(text)) {
    for (let i = 0; i < 120; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDuration = (0.4 + Math.random()) + 's';
      bg.appendChild(p);
    }
  }

  if (/snow/i.test(text)) {
    for (let i = 0; i < 100; i++) {
      const s = document.createElement('div');
      s.className = 'particle';
      s.style.left = Math.random() * 100 + '%';
      s.style.height = '4px';
      s.style.background = 'white';
      s.style.animationDuration = (1.5 + Math.random() * 2) + 's';
      bg.appendChild(s);
    }
  }
}

async function renderForecast() {
  try {
    const now = new Date();
    const coords = await getLocation();
    const data = await fetchForecast(coords.latitude, coords.longitude);

    const container = document.getElementById('forecast-container');
    container.innerHTML = '';

    const daily = {};

    data.properties.periods
      .filter(p => new Date(p.startTime) >= now) // üî• REMOVE PAST HOURS
      .forEach(p => {
        const day = p.startTime.split('T')[0];
        if (!daily[day]) daily[day] = [];
        daily[day].push(p);
      });

    Object.keys(daily).slice(0, 5).forEach(day => {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day-container';
      dayDiv.innerHTML = `<h2>${new Date(day).toDateString()}</h2><div class="hourly-container"></div>`;
      container.appendChild(dayDiv);

      const hc = dayDiv.querySelector('.hourly-container');

      daily[day].forEach(hour => {
        const card = document.createElement('div');
        card.className = 'hour-card';

        card.innerHTML = `
          <div class="hour-summary">
            <div>
              <strong>${new Date(hour.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</strong><br>
              ${hour.temperature}¬∞${hour.temperatureUnit}
            </div>
            <img src="${hour.icon}" width="40">
            <div class="expand-btn">+</div>
          </div>
          <div class="hour-details">
            <p>${hour.shortForecast}</p>
            <p>Wind: ${hour.windSpeed} ${hour.windDirection}</p>
            <p>Precip: ${hour.probabilityOfPrecipitation.value ?? 0}%</p>
          </div>
        `;

        card.querySelector('.expand-btn')
          .addEventListener('click', () => card.classList.toggle('expanded'));

        hc.appendChild(card);
      });
    });

    const current = data.properties.periods[0];
    setWeatherBackground(current.shortForecast, current.isDaytime);

  } catch (e) {
    console.error(e);
    document.getElementById('forecast-container').innerHTML =
      '<p>Enable location to load forecast.</p>';
  }
}

renderForecast();
setInterval(renderForecast, REFRESH_INTERVAL); // üîÅ AUTO UPDATE EVERY 5 MIN
</script>
</body>
</html>
